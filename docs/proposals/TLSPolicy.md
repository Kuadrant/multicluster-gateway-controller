# WIP
# TLSPolicy API
Currently, TLS certificates issued by the MGC are issued and managed using `cert-manager`. Configuration for these certificates are opaque to the end-user - we'd like to gradually expose a TLSPolicy to cover a range of use cases where administrators require more flexible configuration.

## Problem

Gateway Administrators require a comprehensive way to manage Automated, ACME-based TLS for Gateways. As gateways multiply and scale, there's a need for a flexible, policy-based API for handling Automatic TLS. Currently (July 2023), the MGC sets up automated TLS whenever a Gateway listener is created. There are currently no hooks into the creation of automated TLS certificates, nor user-exposed configuration options in terms ACME providers, custom renewal windows/schedules, key size, algorithm and other configuration options available via `cert-manager`.

## Use Cases

**Choosing a TLS Provider**: As an admin, I want to select a specific ACME provider for the TLS certificates in a particular gateway.

**Setting the TLS Certificate Renewal Window**: As an admin, I need to define the renewal period for TLS certificates (e.g., every 90 days) and a lead time for renewals (e.g., 15 days before expiration).

**Choosing a TLS Strategy**: As an admin, I want to employ different strategies for managing certificates (e.g., multiple host certificate or per host certificate).

**Choosing a TLS Strategy**: As an admin, I want to be able to apply enterprise security standards to certificates generated by the MGC. I want to be able to specify certificate key size, algorithm and encoding.


## Current implementation



## Goals

- Design an API that allows admins to handle Automatic TLS for any given gateway.
- Facilitate easy selection of a TLS provider.
- Allow admins to set the renewal window for TLS certificates.
- Enable the use of different TLS strategies.
- Consider additional TLS configurations such as enforcing HTTPS listeners and supporting wildcard hosts.

## Non-Goals

- Detailed implementation of the API.
- Developing a working prototype of the API.
- Identifying specific technologies or tools for implementing the API.
- Abstracting cert-manager Issuer/ClusterIssuer configuration.

## Terms

- **Automatic TLS**: Automatic management of TLS certificates for gateways.
- **TLS Provider**: The entity providing TLS certificates.
- **TLS Strategy**: The method used for managing and distributing TLS certificates across hosts.

## Proposal

The proposed solution is the TLSPolicy API. It allows administrators to select a TLS provider, define a renewal window for TLS certificates, and choose a TLS strategy. The API will support multiple host certificates and per-host certificates.

The API will also consider additional TLS configurations, such as enforcing only HTTPS listeners and supporting wildcard hosts. This means any gateways using this class would have any non-HTTPS listeners flagged, removed, or not synced, etc. 

**Note** This proposal effectively moves us away from having a "default" TLS policy, baked into the MGC. From here on, unless a TLSPolicy is defined, MGC will not do anything with TLS, and control will remain with the user to solve.

## Gateway Interaction

The TLSPolicy API will interact with Gateway operations, such as adding and removing TLS configurations for a listener based on the host. This allows for dynamic management of TLS configurations for each Gateway and its listeners. The API will utilize the existing Gateway methods for adding, removing, and checking TLS status.

## Example Policies

1. **Policy**

```yaml
apiVersion: kuadrant.io/v1alpha1
kind: TLSPolicy
spec:
  targetRef: # defaults to gateway gvk and currrent namespace
    name: gateway-name
  duration: 2160h # 90d - certificate validity period
  renewBefore: 360h # 15d - certificate renewal buffer in hours
  PrivateKey:
    Algorithm: RSA # certman.RSAKeyAlgorithm
    Encoding: PKCS1 # certman.PKCS1
    Size: 2048
```

TBD - some other variants to consider:

* Target an entire gateway
* Specific policy for a specific host
* Specific policy for a specific managedzone
* Overrides?

## Considerations and Limitations

TBD